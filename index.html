{% extends "base.html" %}
{% block title %}Главная{% endblock %}
{% block content %}
<div class="card">
  <h1>Управление analizador.py</h1>
  <p class="muted">Запуск и остановка парсера.</p>
  <p><b>Статус процесса:</b> {{ "Запущен" if is_running else "Остановлен" }}</p>
  <div style="display:flex;gap:8px;flex-wrap:wrap;">
    <form method="post" action="{{ url_for('run_analizador') }}"><button type="submit">Запустить</button></form>
    <form method="post" action="{{ url_for('stop_analizador') }}"><button type="submit">Остановить</button></form>
  </div>
</div>

<div class="card">
  <h3>Прогресс парсера</h3>
  <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
    <span id="progressMessage">{{ progress.message }}</span>
    <b id="progressPercent">{{ progress.percent }}%</b>
  </div>
  <div style="width:100%; height:16px; background:#e5e7eb; border-radius:8px; overflow:hidden;">
    <div id="progressBar" style="height:100%; width:{{ progress.percent }}%; background:#0b67d0; transition:width 0.3s ease;"></div>
  </div>
  <div style="margin-top:6px;" class="muted">
    Статус: <span id="progressStatus">{{ progress.status }}</span> |
    Этап: <span id="progressStage">{{ progress.stage }}</span> |
    Шаг: <span id="progressStep">{{ progress.current }}/{{ progress.total }}</span>
  </div>
</div>

<script>
  async function refreshProgress() {
    try {
      const res = await fetch("{{ url_for('progress') }}", { cache: 'no-store' });
      if (!res.ok) return;
      const p = await res.json();

      document.getElementById('progressBar').style.width = `${p.percent || 0}%`;
      document.getElementById('progressPercent').textContent = `${p.percent || 0}%`;
      document.getElementById('progressMessage').textContent = p.message || '';
      document.getElementById('progressStatus').textContent = p.status || 'idle';
      document.getElementById('progressStage').textContent = p.stage || 'idle';
      document.getElementById('progressStep').textContent = `${p.current || 0}/${p.total || 1}`;
    } catch (e) {
      // ignore polling errors
    }
  }

  setInterval(refreshProgress, 2000);
</script>
{% endblock %}
